/*

  ******************************************************************************
  * @file 			( фаил ):   FourDigit74HC595.c
  * @brief 		( описание ):  	
  ******************************************************************************
  * @attention 	( внимание ):	author: Golinskiy Konstantin	e-mail: golinskiy.konstantin@gmail.com
  ******************************************************************************
  
*/

/* Includes ----------------------------------------------------------*/
#include "FourDigit74HC595.h"

uint8_t LED_NUM[] = {
	0xC0, //0
	0xF9, //1
	0xA4, //2
	0xB0, //3
	0x99, //4
	0x92, //5
	0x82, //6
	0xF8, //7
	0x80, //8
	0x90, //9
	0xBF  //-
};
	
/*
	******************************************************************************
	* @brief	 ( описание ):  функция для отправки данных в микросхему
	* @param	( параметры ):	1 байт информации
	* @return  ( возвращает ):	

	******************************************************************************
*/
static void FourDigit74HC595_sendData(uint8_t data){
	
	for(int8_t i=0; i<8; i++){         
		  if( data & (0x80 >> i ) ){
			HAL_GPIO_WritePin (DIO_GPIO_Port, DIO_Pin, GPIO_PIN_SET);
		  }
		  else{
			HAL_GPIO_WritePin (DIO_GPIO_Port, DIO_Pin, GPIO_PIN_RESET);  
		  }
		  
		  HAL_GPIO_WritePin (SCLK_GPIO_Port, SCLK_Pin, GPIO_PIN_SET );
		  HAL_GPIO_WritePin (SCLK_GPIO_Port, SCLK_Pin, GPIO_PIN_RESET );
	}
}
//----------------------------------------------------------------------------------


/*
	******************************************************************************
	* @brief	 ( описание ):  функция формирует одно разрядное число ( 1 цифру )
								в указаном разряде ( можно совместно включить точку )
	* @param	( параметры ):	1- позиция ( разряд ) где отабразить значение от 1 до 4
								2- сама цифра от 0 до 9 ( если нужен знак минус то ставим 10 )
								3- точка ( 1 включить,  0 выключить )
	* @return  ( возвращает ):	

	******************************************************************************
*/
void FourDigit74HC595_sendOneDigit(uint8_t pos, uint8_t digit, uint8_t dot){
	
	// отправляем число от 0 до 9 или занак минус ( число 10 )
	if( dot ){
		FourDigit74HC595_sendData( LED_NUM[ digit ] & 0x7F );	// если нужна точка
	}
	else{
		FourDigit74HC595_sendData( LED_NUM[ digit ]  );			// если точка не нужна
	}
	
	// отправляем номер разряда от 1 до 4
	if( pos == 0x01 ){
		FourDigit74HC595_sendData( 0x01 );
	}
	else if( pos == 0x02 ){
		FourDigit74HC595_sendData( 0x02 );
	}
	else if( pos == 0x03 ){
		FourDigit74HC595_sendData( 0x04 );
	}
	else if( pos == 0x04 ){
		FourDigit74HC595_sendData( 0x08 );
	}
	
	HAL_GPIO_WritePin (RCLK_GPIO_Port, RCLK_Pin, GPIO_PIN_RESET );	// отключаем засчелку
	HAL_GPIO_WritePin (RCLK_GPIO_Port, RCLK_Pin, GPIO_PIN_SET );	// включаем засчелку
	
	HAL_Delay (1);
}
//----------------------------------------------------------------------------------


/*
	******************************************************************************
	* @brief	 ( описание ):  функция для отображения любого числа на дисплее
	* @param	( параметры ):	строка которую нужно отабразить :
								символы цифры от 0 до 9 
								знак минус ( может быть не один )
								знак точка ( может быть не один )
								Напримар: "-10.56" "0.56" "-2 -2.3" "1.2.3.4." "-23-" и т.д

	* @return  ( возвращает ):	

	******************************************************************************
*/
void FourDigit74HC595_sendNumber(char* num){
	
	uint8_t len = strlen( num );
	uint8_t dot = 0;
	
	while( len ){
		if( num[len -1 ] == '.' ){
			dot++;
		}
		len--;
	}
	
	if( strlen( num ) - dot > 4 ){
		FourDigit74HC595_sendOneDigit( 0x01, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x02, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x03, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x04, 10, 0 );
		
		len = 0;
	}
	else{
		len = strlen( num );
	}
	
	uint8_t position = 1;
	dot = 0;
	
	while( len ){
		
		if(num[len-1] == '-'){
			FourDigit74HC595_sendOneDigit( position, 10, dot );	
			dot = 0;
			position++;
		}
		else if(num[len-1] == '.'){
			dot = 1;
		}
		else if(num[len-1] == ' '){
			position++;
		}
		else{
			FourDigit74HC595_sendOneDigit( position, num[len-1]-48, dot );	
			dot = 0;
			position++;
		}
		
		len--;
		
		if( position > 4 ) { 
			break; 
		}
	}
}
//----------------------------------------------------------------------------------


/*
	******************************************************************************
	* @brief	 ( описание ):  функция для отображения INT целочисленного числа на дисплее
	* @param	( параметры ):	число целочисленное :
								цифры от -999 до 9999 

	* @return  ( возвращает ):	

	******************************************************************************
*/
void FourDigit74HC595_sendNumberInt(int16_t num){
	
	uint8_t position = 1;
	
	if( num == 0 ){
		
		FourDigit74HC595_sendOneDigit( 1, 0, 0 );
		
	}
	else if( ((num < 0) && (num / 1000)) || ((num > 0) && (num / 10000)) ){
		
		FourDigit74HC595_sendOneDigit( 0x01, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x02, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x03, 10, 0 );
		FourDigit74HC595_sendOneDigit( 0x04, 10, 0 );
		
	}
	else{
		uint8_t minus = 0;
		if( num < 0 ){
			minus = 1;
			num = num * -1;
		}
		while( num ){

			FourDigit74HC595_sendOneDigit( position, num % 10, 0 );
			num = num / 10;
			position++;
			
			if( position > 4 ) { break; }
		}
		if( minus ){
			FourDigit74HC595_sendOneDigit( position, 10, 0 );
		}
	}
	
}

char* intToChar(int num) {
  // Allocate memory for the character array (start with a small initial size)
  char* str = (char*)malloc(8 * sizeof(char)); // Allocate 8 bytes initially
  if (!str) {
    return NULL; // Handle memory allocation failure
  }

  // Initialize variables
  int i = 0;
  int isNegative = num < 0;
  if (isNegative) {
    num *= -1; // Convert to positive for processing
    str[i++] = '-'; // Add '-' for negative numbers
  }

  // Convert digits one by one
  while (num > 0) {
    int digit = num % 10;
    str[i++] = digit + '0'; // Convert digit to ASCII character
    num /= 10;

    // Check if more space is needed
    if (i == 8) {
      // Reallocate memory if the current array is full
      char* newStr = (char*)realloc(str, (i + 8) * sizeof(char));
      if (!newStr) {
        free(str); // Free the previously allocated memory
        return NULL; // Handle reallocation failure
      }
      str = newStr; // Update the pointer to the new array
    }
  }

  // Add null terminator
  str[i] = '\0';

  return str; // Return the converted character array
}

void FourDigit74HC595_sendNumberNew(char* num) {
  uint8_t dataArray[4] = {0, 0, 0, 0}; // Array to store digit data for each position
  uint8_t len = strlen(num);
  uint8_t dot = 0;

  // Process the number string
  while (len) {
    if (num[len - 1] == '.') {
      dot++;
    }
    len--;
  }

  if (strlen(num) - dot > 4) { // Handle overflow (number too large)
    for (int i = 0; i < 4; i++) {
      dataArray[i] = LED_NUM[10]; // Display '-' for all positions
    }
  } else {
    len = strlen(num);
    uint8_t position = 1;
    dot = 0;

    while (len) {
      if (num[len - 1] == '-') {
        dataArray[position - 1] = LED_NUM[10]; // Display '-'
        dot = 0;
        position++;
      } else if (num[len - 1] == '.') {
        dot = 1;
      } else if (num[len - 1] == ' ') {
        position++;
      } else {
        dataArray[position - 1] = (dot ? (LED_NUM[num[len - 1] - 48] & 0x7F) : LED_NUM[num[len - 1] - 48]); // Set digit data with/without dot
        dot = 0;
        position++;
      }

      len--;

      if (position > 4) {
        break; // Limit to 4 digits
      }
    }
  }

  // Send the data array to the LED screen simultaneously
  for (int i = 0; i < 8; i++) {
    for (int j = 0; j < 4; j++) {
      if (dataArray[j] & (0x80 >> i)) {
        HAL_GPIO_WritePin(DIO_GPIO_Port, DIO_Pin, GPIO_PIN_SET);
      } else {
        HAL_GPIO_WritePin(DIO_GPIO_Port, DIO_Pin, GPIO_PIN_RESET);
      }
    }

    HAL_GPIO_WritePin(SCLK_GPIO_Port, SCLK_Pin, GPIO_PIN_SET);
    HAL_GPIO_WritePin(SCLK_GPIO_Port, SCLK_Pin, GPIO_PIN_RESET);
  }

  // Toggle the RCLK pin to latch the data
  HAL_GPIO_WritePin(RCLK_GPIO_Port, RCLK_Pin, GPIO_PIN_RESET);
  HAL_GPIO_WritePin(RCLK_GPIO_Port, RCLK_Pin, GPIO_PIN_SET);

  HAL_Delay(1); // Delay for stability
}

//----------------------------------------------------------------------------------



/************************ (C) COPYRIGHT GKP *****END OF FILE****/
